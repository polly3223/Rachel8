---
phase: 01-foundation-deployment
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/setup/validate.ts
  - src/setup/validate.test.ts
  - src/setup/wizard.ts
  - src/setup/install.ts
  - src/index.ts
autonomous: true

must_haves:
  truths:
    - "Setup wizard collects Claude API key with format validation and instructions"
    - "Setup wizard collects Telegram bot token with format validation and BotFather instructions"
    - "Setup wizard collects Exa API key with format validation and instructions"
    - "Setup wizard auto-detects /data/shared/vault or asks for shared folder path"
    - "Setup wizard writes valid .env file that passes Zod validation"
    - "Setup wizard installs and enables systemd service"
    - "Rachel entry point validates config and starts with graceful shutdown"
    - "All required API keys must be provided before wizard completes"
  artifacts:
    - path: "src/setup/validate.ts"
      provides: "API key format validators for Claude, Telegram, Exa"
      exports: ["validateAnthropicKey", "validateTelegramToken", "validateExaKey"]
    - path: "src/setup/validate.test.ts"
      provides: "Tests for all validation functions"
      contains: "describe"
    - path: "src/setup/wizard.ts"
      provides: "Interactive CLI wizard using @clack/prompts"
      contains: "group"
    - path: "src/setup/install.ts"
      provides: "systemd service installer"
      exports: ["installSystemdService"]
    - path: "src/index.ts"
      provides: "Application entry point with config validation and graceful shutdown"
      contains: "SIGTERM"
  key_links:
    - from: "src/setup/wizard.ts"
      to: "src/setup/validate.ts"
      via: "imports validators for prompt validation"
      pattern: "import.*validate"
    - from: "src/setup/wizard.ts"
      to: ".env"
      via: "Bun.write() after collecting all config"
      pattern: "Bun\\.write.*\\.env"
    - from: "src/setup/wizard.ts"
      to: "src/setup/install.ts"
      via: "calls installSystemdService after writing .env"
      pattern: "installSystemdService"
    - from: "src/index.ts"
      to: "src/config/env.ts"
      via: "imports validated env, fails fast if invalid"
      pattern: "import.*env"
    - from: "src/index.ts"
      to: "src/lib/logger.ts"
      via: "imports logger for startup messages"
      pattern: "import.*logger"
---

<objective>
Build the interactive setup wizard that collects all API keys and configuration, the API key format validators (with tests), the systemd service installer, and Rachel's main entry point. After this plan, running `bun run setup` walks the user through complete configuration, and `bun run start` launches Rachel with validated config.

Purpose: This is the core user-facing setup experience and the application entry point. Without it, Rachel cannot be configured or started.
Output: Working setup wizard, tested validators, systemd installer, and entry point.
</objective>

<execution_context>
@/Users/lory/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lory/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-deployment/01-RESEARCH.md
@.planning/phases/01-foundation-deployment/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create API key validators with tests</name>
  <files>
    src/setup/validate.ts
    src/setup/validate.test.ts
  </files>
  <action>
**src/setup/validate.ts:**
Create format-check validators (no live API calls — user decision). Each validator returns undefined on success, or a string error message on failure. These are used by both the wizard prompts (inline validation) and can be used standalone.

- `validateAnthropicKey(value: string): string | undefined`
  - Must match: `/^sk-ant-api03-[a-zA-Z0-9_-]+$/`
  - Error: "Invalid format. Claude API keys start with sk-ant-api03-"
  - Also reject empty string: "API key is required"

- `validateTelegramToken(value: string): string | undefined`
  - Must match: `/^\d{8,}:[A-Za-z0-9_-]{35,}$/`
  - Error: "Invalid format. Telegram tokens look like 123456789:ABCdef... (get one from @BotFather)"
  - Also reject empty string: "Bot token is required"

- `validateExaKey(value: string): string | undefined`
  - Must be at least 10 characters (no documented prefix — research open question)
  - Error: "Invalid format. Exa API keys are at least 10 characters"
  - Also reject empty string: "API key is required"

- `validateFolderPath(value: string): string | undefined`
  - Must be non-empty
  - Must start with "/" (absolute path)
  - Error: "Path must be absolute (start with /)"
  - Also reject empty string: "Folder path is required"

**src/setup/validate.test.ts:**
Write thorough tests using bun:test (describe/test/expect):

For each validator, test:
- Valid input returns undefined
- Empty string returns error
- Invalid format returns descriptive error
- Edge cases (almost-valid strings, wrong prefix, etc.)

Specific test cases:
- Anthropic: "sk-ant-api03-abc123_DEF-456" (valid), "sk-ant-" (invalid, wrong prefix length), "sk-ant-api03-" (invalid, no body), "invalid" (invalid)
- Telegram: "123456789:ABCdefGHIjklMNOpqrstuvwxyz12345" (valid), "short:abc" (invalid), "notanumber:token" (invalid)
- Exa: "abcdefghij" (valid, 10 chars), "short" (invalid, < 10)
- Folder: "/data/shared/vault" (valid), "relative/path" (invalid), "" (invalid)
  </action>
  <verify>
Run `bun test src/setup/validate.test.ts` — all tests pass.
Run `bunx tsc --noEmit` — no TypeScript errors.
  </verify>
  <done>
All 4 validators exported and working. Tests cover valid, empty, and invalid format cases. `bun test` passes with 100% of test cases green.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build interactive setup wizard and systemd installer</name>
  <files>
    src/setup/wizard.ts
    src/setup/install.ts
  </files>
  <action>
**src/setup/wizard.ts:**
Build the interactive setup wizard using @clack/prompts (per user decision: step-by-step like npm init, block until valid).

Flow:
1. `intro("Rachel8 Setup")` — welcome banner
2. `note()` — brief explanation: "This wizard will configure Rachel8. You'll need API keys from three services."
3. Use `group()` to collect all config in a single cancelable flow:
   - `anthropicKey`: text() prompt
     - message: "Claude API key"
     - placeholder: "sk-ant-api03-..."
     - validate: validateAnthropicKey
     - Before prompt, show note with instructions: "Get your API key from https://console.anthropic.com/settings/keys"
   - `telegramToken`: text() prompt
     - message: "Telegram bot token"
     - placeholder: "123456789:ABCdef..."
     - validate: validateTelegramToken
     - Before group or as note: "Create a bot: open Telegram, message @BotFather, send /newbot, follow prompts, copy the token"
   - `exaKey`: text() prompt
     - message: "Exa API key"
     - validate: validateExaKey
     - Note: "Get your API key from https://dashboard.exa.ai/api-keys"
   - `sharedFolder`: text() prompt
     - message: "Shared folder path"
     - Auto-detect: check if /data/shared/vault exists. If yes, use as initialValue. If not, use empty string.
     - validate: validateFolderPath
     - After validation, check if path exists on filesystem. If not, ask confirm() whether to create it. If user confirms, create with mkdir -p equivalent.
   - Handle onCancel: cancel("Setup cancelled.") and process.exit(0)

4. After group completes, run tasks() sequence (per research discretion recommendation):
   - Task "Writing configuration...": Write .env file using Bun.write() with all collected values plus NODE_ENV=production and LOG_LEVEL=info
   - Task "Installing systemd service...": Call installSystemdService() from install.ts
     - This step should ask confirm() first: "Install systemd service? (requires sudo)"
     - If user declines, skip and note they can install later

5. `outro()` — show success message with next steps

IMPORTANT: Since @clack/prompts group() doesn't support showing notes between prompts, use individual prompts outside group OR use sequential text() calls with isCancel() checks instead of group(). Choose whichever approach lets you show API key instructions before each prompt. The user decision says "step-by-step, like npm init" which favors sequential prompts.

**src/setup/install.ts:**
Create the systemd service installer function.

- Export `async function installSystemdService(): Promise<void>`
- Read the rachel8.service template from project root
- Replace placeholder paths if needed (detect home directory, user name)
- The service file uses the user's home directory for WorkingDirectory and ExecStart
- Copy service file to /etc/systemd/system/ using sudo (via Bun.spawn or $`sudo cp ...`)
- Run: sudo systemctl daemon-reload
- Run: sudo systemctl enable rachel8
- Run: sudo systemctl start rachel8
- Check systemd version: if < 254, warn that RestartSteps is not supported (exponential backoff will be fixed-interval)
- Handle errors gracefully: if sudo fails, print message and suggest manual installation
- Log each step using the logger
  </action>
  <verify>
Run `bunx tsc --noEmit` — no TypeScript errors.
Run `bun run src/setup/wizard.ts` in a test terminal — wizard prompts appear, accepts input, writes .env file (test with dummy values).
Verify .env file is written with correct format after wizard completion.
  </verify>
  <done>
Wizard runs interactively, collects all 4 config values with inline validation, shows instructions for each API key, auto-detects shared folder, writes .env file, and optionally installs systemd service. install.ts handles systemd setup with sudo commands and error handling.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Rachel entry point with config validation and graceful shutdown</name>
  <files>
    src/index.ts
  </files>
  <action>
**src/index.ts:**
Create the main entry point that Rachel starts from. For Phase 1, this is a minimal startup that validates config and stays alive.

1. Import env from ./config/env.ts (this triggers Zod validation — fail fast)
2. Import logger from ./lib/logger.ts
3. Log startup: logger.info("Rachel8 starting...", { env: env.NODE_ENV })
4. Log config summary (DO NOT log API keys): logger.info("Configuration loaded", { sharedFolder: env.SHARED_FOLDER_PATH, logLevel: env.LOG_LEVEL })
5. Register graceful shutdown handlers:
   - process.on("SIGTERM", shutdown) — systemd sends this on stop
   - process.on("SIGINT", shutdown) — Ctrl+C in terminal
   - shutdown function: logger.info("Shutting down..."), then process.exit(0)
6. Log ready: logger.info("Rachel8 is running. Waiting for connections...")
7. The process stays alive because later phases will add the HTTP server (grammY webhook) and queue workers. For now, just keep the process alive so systemd doesn't think it crashed. Use a simple approach: `setInterval(() => {}, 1 << 30)` (max safe interval) or `Bun.serve()` on a health check port, or `await new Promise(() => {})` (never resolves). Choose the simplest: `setInterval(() => {}, 60_000)` with a debug log heartbeat.

Keep it minimal. Later phases will add Telegram bot initialization, agent setup, and queue workers here.
  </action>
  <verify>
Create a test .env file with dummy valid values. Run `bun run src/index.ts` — should print startup messages and stay running.
Send SIGINT (Ctrl+C) — should print shutdown message and exit cleanly.
Delete .env and run again — should print friendly "no .env found" message and exit 0.
Run `bunx tsc --noEmit` — no TypeScript errors.
  </verify>
  <done>
Entry point starts Rachel, validates config via Zod, logs startup info (without secrets), handles SIGTERM/SIGINT gracefully, and keeps process alive. Missing .env produces friendly message and clean exit (no crash loop with systemd).
  </done>
</task>

</tasks>

<verification>
1. `bun test` — all validator tests pass
2. `bunx tsc --noEmit` — no TypeScript errors across all files
3. `bun run setup` — wizard launches, collects input, writes .env
4. `bun run start` — Rachel starts, logs config summary, stays running
5. Ctrl+C during `bun run start` — graceful shutdown message, clean exit
6. `bun run start` without .env — friendly error, exit 0
</verification>

<success_criteria>
- All 4 validators have passing tests
- Wizard collects Claude key, Telegram token, Exa key, and shared folder path
- Wizard shows clear instructions for obtaining each API key
- Wizard auto-detects /data/shared/vault if it exists
- Wizard writes valid .env that passes Zod validation
- Entry point validates config and handles graceful shutdown
- No TypeScript strict mode violations
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-deployment/01-02-SUMMARY.md`
</output>
