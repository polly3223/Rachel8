---
phase: 02-telegram-integration-auth
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/config/env.ts
  - .env.example
  - src/setup/wizard.ts
  - src/setup/validate.ts
  - src/telegram/bot.ts
  - src/telegram/middleware/auth.ts
autonomous: true
user_setup:
  - service: telegram
    why: "Need owner's Telegram user ID for single-user auth"
    env_vars:
      - name: OWNER_TELEGRAM_USER_ID
        source: "Send /start to @userinfobot on Telegram to get your numeric user ID"

must_haves:
  truths:
    - "Bot token is validated and bot instance can be created"
    - "Only the owner's Telegram user ID passes the auth guard"
    - "Unauthorized users are silently ignored with a log warning"
    - "Typing indicator middleware is installed on the bot"
    - "Bot has an error handler that logs errors without crashing"
  artifacts:
    - path: "src/telegram/bot.ts"
      provides: "grammY bot instance with middleware stack"
      exports: ["bot", "BotContext"]
    - path: "src/telegram/middleware/auth.ts"
      provides: "Single-user auth guard middleware"
      exports: ["authGuard"]
    - path: "src/config/env.ts"
      provides: "OWNER_TELEGRAM_USER_ID in validated env"
      contains: "OWNER_TELEGRAM_USER_ID"
  key_links:
    - from: "src/telegram/middleware/auth.ts"
      to: "src/config/env.ts"
      via: "imports env.OWNER_TELEGRAM_USER_ID"
      pattern: "env\\.OWNER_TELEGRAM_USER_ID"
    - from: "src/telegram/bot.ts"
      to: "src/telegram/middleware/auth.ts"
      via: "bot.use(authGuard)"
      pattern: "bot\\.use\\(authGuard\\)"
---

<objective>
Install Telegram dependencies, add owner user ID to config, and create the grammY bot instance with single-user auth middleware and typing indicator support.

Purpose: Establish the Telegram bot foundation that all message handling builds on -- a running bot that authenticates the owner and shows typing indicators.
Output: Bot instance ready to accept handlers, auth middleware filtering unauthorized users, config updated with OWNER_TELEGRAM_USER_ID.
</objective>

<execution_context>
@/Users/lory/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lory/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-telegram-integration-auth/02-RESEARCH.md
@src/config/env.ts
@src/setup/wizard.ts
@src/setup/validate.ts
@package.json
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and add OWNER_TELEGRAM_USER_ID to config and wizard</name>
  <files>
    package.json
    src/config/env.ts
    .env.example
    src/setup/wizard.ts
    src/setup/validate.ts
  </files>
  <action>
1. Install dependencies:
   ```bash
   bun add grammy @anthropic-ai/sdk @grammyjs/auto-chat-action
   ```

2. Update `src/config/env.ts` — add OWNER_TELEGRAM_USER_ID to the envSchema:
   ```typescript
   OWNER_TELEGRAM_USER_ID: z.coerce.number().int().positive({
     message: "Must be a positive integer. Send /start to @userinfobot on Telegram to find your user ID",
   }),
   ```
   Place it after TELEGRAM_BOT_TOKEN. Use `z.coerce.number()` because env vars are always strings but Telegram user IDs are numbers (see Research pitfall 3).

3. Update `.env.example` — add after the TELEGRAM_BOT_TOKEN line:
   ```
   # Your Telegram user ID (send /start to @userinfobot to find it)
   OWNER_TELEGRAM_USER_ID=
   ```

4. Update `src/setup/validate.ts` — add a validator for the owner user ID:
   ```typescript
   export function validateOwnerUserId(value: string | undefined): string | undefined {
     if (!value || value.length === 0) return "User ID is required";
     if (!/^\d+$/.test(value)) return "Must be a number. Send /start to @userinfobot on Telegram";
     const num = Number(value);
     if (num <= 0 || !Number.isInteger(num)) return "Must be a positive integer";
     return undefined;
   }
   ```

5. Update `src/setup/wizard.ts` — add a prompt for OWNER_TELEGRAM_USER_ID after the Telegram bot token prompt (after `handleCancel(telegramToken)`):
   ```typescript
   // 2b. Owner Telegram user ID
   log.info(
     "Send /start to @userinfobot on Telegram to get your user ID.\n" +
       "This is a number like 123456789.",
   );

   const ownerUserId = await text({
     message: "Your Telegram user ID",
     placeholder: "123456789",
     validate: validateOwnerUserId,
   });
   handleCancel(ownerUserId);
   ```
   Import `validateOwnerUserId` from `./validate.ts`.
   Add `OWNER_TELEGRAM_USER_ID=${ownerUserId}` to the envContent array in the .env writer section (after TELEGRAM_BOT_TOKEN line).
  </action>
  <verify>
    Run `bun run src/config/env.ts` (will fail due to missing .env but confirms no syntax errors). Verify grammy, @anthropic-ai/sdk, and @grammyjs/auto-chat-action appear in package.json dependencies. Check that OWNER_TELEGRAM_USER_ID appears in env schema, .env.example, wizard, and validate.ts.
  </verify>
  <done>
    grammy, @anthropic-ai/sdk, @grammyjs/auto-chat-action installed. OWNER_TELEGRAM_USER_ID added to env schema (z.coerce.number), .env.example, setup wizard (with @userinfobot instructions), and validate.ts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Telegram bot instance with auth middleware and typing indicator</name>
  <files>
    src/telegram/bot.ts
    src/telegram/middleware/auth.ts
  </files>
  <action>
1. Create `src/telegram/middleware/auth.ts` — single-user auth guard:
   ```typescript
   import type { Context, NextFunction } from "grammy";
   import { env } from "../../config/env.ts";
   import { logger } from "../../lib/logger.ts";

   export async function authGuard(ctx: Context, next: NextFunction): Promise<void> {
     const userId = ctx.from?.id;

     if (userId !== env.OWNER_TELEGRAM_USER_ID) {
       logger.warn("Unauthorized access attempt", { userId });
       // Silent ignore — don't reveal bot exists to unauthorized users
       return;
     }

     await next();
   }
   ```
   Important: Compare `ctx.from?.id` (number) directly to `env.OWNER_TELEGRAM_USER_ID` (also number thanks to z.coerce.number). No type conversion needed. Silent ignore per Research recommendation (open question 2).

2. Create `src/telegram/bot.ts` — bot instance with middleware stack:
   ```typescript
   import { Bot, type Context, GrammyError, HttpError } from "grammy";
   import { autoChatAction, type AutoChatActionFlavor } from "@grammyjs/auto-chat-action";
   import { env } from "../config/env.ts";
   import { logger } from "../lib/logger.ts";
   import { authGuard } from "./middleware/auth.ts";

   export type BotContext = Context & AutoChatActionFlavor;

   export const bot = new Bot<BotContext>(env.TELEGRAM_BOT_TOKEN);

   // Middleware stack — order matters: auth first, then typing indicator
   bot.use(authGuard);
   bot.use(autoChatAction());

   // /start command — friendly greeting
   bot.command("start", (ctx) => ctx.reply("Hello! I'm Rachel, your personal AI assistant."));

   // Error handler — log and continue, don't crash the polling loop
   bot.catch((err) => {
     const ctx = err.ctx;
     const e = err.error;

     logger.error(`Error handling update ${ctx.update.update_id}`, {
       error: e instanceof GrammyError
         ? e.description
         : e instanceof HttpError
           ? `Network error: ${e.message}`
           : e instanceof Error
             ? e.message
             : String(e),
     });
   });
   ```
   Note: Handlers (like message handler) are NOT registered here — they come in Plan 02. The /start command is included as a basic health check. The bot module exports `bot` and `BotContext` for use by handlers and the entry point.
  </action>
  <verify>
    Run `bunx tsc --noEmit` (or `bun run src/telegram/bot.ts` to check for import/syntax errors). Verify auth.ts imports env and logger. Verify bot.ts registers authGuard before autoChatAction. Verify BotContext type is exported.
  </verify>
  <done>
    Bot instance created with auth middleware (silent ignore for unauthorized users), auto-chat-action plugin for typing indicators, /start command, and error handler. BotContext type exported for handlers.
  </done>
</task>

</tasks>

<verification>
1. `bun add` completed without errors — grammy, @anthropic-ai/sdk, @grammyjs/auto-chat-action in package.json
2. `src/config/env.ts` contains OWNER_TELEGRAM_USER_ID with z.coerce.number().int().positive()
3. `.env.example` has OWNER_TELEGRAM_USER_ID field with instructions
4. `src/setup/wizard.ts` prompts for owner user ID with @userinfobot instructions
5. `src/setup/validate.ts` exports validateOwnerUserId
6. `src/telegram/bot.ts` creates Bot<BotContext>, registers authGuard then autoChatAction, has bot.catch()
7. `src/telegram/middleware/auth.ts` compares ctx.from?.id to env.OWNER_TELEGRAM_USER_ID, silent return on mismatch
8. No TypeScript compilation errors
</verification>

<success_criteria>
- grammy, @anthropic-ai/sdk, @grammyjs/auto-chat-action are installed
- OWNER_TELEGRAM_USER_ID is in env schema, .env.example, wizard, and validator
- Bot instance exists with auth middleware and typing indicator plugin
- Auth guard silently ignores non-owner users and logs the attempt
- Error handler prevents bot crashes on individual update failures
</success_criteria>

<output>
After completion, create `.planning/phases/02-telegram-integration-auth/02-01-SUMMARY.md`
</output>
